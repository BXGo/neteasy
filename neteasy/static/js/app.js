// Generated by CoffeeScript 1.12.5
(function() {
  angular.module('app', ['ngSanitize']).controller('RootController', [
    '$scope', '$sce', '$http', '$interval', 'util', function($scope, $sce, $http, $interval, util) {
      var $scan_progress_bar;
      $scan_progress_bar = $('#scan_progress_bar');
      $scan_progress_bar.progress();
      $scope.app = {
        name: 'NetEasy Music Player',
        title: 'NetEasy',
        copyright: $sce.trustAsHtml('This web application was created by ' + '<a href="https://github.com/tjumyk" target="_blank">Kelvin Miao</a>.<br>' + 'Copyrights of the music files and music meta data belong to <a target="_blank" href="http://music.163.com">网易云音乐</a>.')
      };
      $scope.scan = function() {
        var int;
        $scope.scanning = true;
        $scope.scan_progress = void 0;
        $scope.error = void 0;
        $scope.music_list = void 0;
        int = $interval(function() {
          if (!$scope.scanning) {
            $interval.cancel(int);
            return;
          }
          return $http.get('/api/status').then(function(response) {
            var status;
            status = response.data;
            return $scope.scan_progress = {
              total: status.scan_total,
              completed: status.scan_completed
            };
          });
        }, 1000);
        return $http.get('/api/scan').then(function(response) {
          $scope.scanning = false;
          return $scope.music_list = response.data;
        }, function(response) {
          $scope.scanning = false;
          return $scope.error = util.formatResponseError(response);
        });
      };
      $scope.get_list = function() {
        $scope.loading = true;
        $scope.error = void 0;
        $scope.music_list = void 0;
        return $http.get('/api/list').then(function(response) {
          $scope.loading = false;
          return $scope.music_list = response.data;
        }, function(response) {
          $scope.loading = false;
          return $scope.error = util.formatResponseError(response);
        });
      };
      $scope.time_to_now = function(time) {
        return moment.unix(time).toNow();
      };
      $scope.play_music = function(music) {
        if ($scope.sound) {
          $scope.sound.stop();
        }
        $scope.sound = new Howl({
          src: ["/music/" + music.mid + "." + music.file.file_format]
        });
        $scope.sound.on('end', function() {
          return $scope.sound.play();
        });
        return $scope.sound.play();
      };
      $scope.get_download_name = function(music) {
        var i, len, ref, singer, singer_names;
        singer_names = [];
        ref = music.meta.singers;
        for (i = 0, len = ref.length; i < len; i++) {
          singer = ref[i];
          singer_names.push(singer.name);
        }
        return music.meta.title + " - " + (singer_names.join(',')) + "." + music.file.file_format;
      };
      $scope.$watch('scan_progress.total', function(total) {
        total = total || 0;
        return $scan_progress_bar.progress('set total', total);
      });
      $scope.$watch('scan_progress.completed', function(completed) {
        completed = completed || 0;
        return $scan_progress_bar.progress('set progress', completed);
      });
      return $http.get('/api/status').then(function(response) {
        var int, status;
        status = response.data;
        if (status.never_scan) {
          return $scope.scan();
        } else {
          if (status.scanning) {
            $scope.scanning = true;
            $scope.scan_progress = {
              total: status.scan_total,
              completed: status.scan_completed
            };
            return int = $interval(function() {
              return $http.get('/api/status').then(function(response) {
                status = response.data;
                $scope.scan_progress = {
                  total: status.scan_total,
                  completed: status.scan_completed
                };
                if (!status.scanning) {
                  $interval.cancel(int);
                  return $scope.get_list();
                }
              });
            }, 1000);
          } else {
            return $scope.get_list();
          }
        }
      });
    }
  ]);

}).call(this);

//# sourceMappingURL=app.js.map
